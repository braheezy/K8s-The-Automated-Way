---

- name: Download installer zip
  get_url:
    url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
    dest: /tmp/awscliv2.zip

- name: Unarchive installer zip
  unarchive:
    src: /tmp/awscliv2.zip
    dest: /tmp/
    remote_src: yes

- name: Run installer script
  become: yes
  command: sh /tmp/aws/install
  args:
    creates: /usr/local/aws-cli

- name: Set default Compute region for AWS
  command: aws configure set default.region {{ aws_region }}

- name: Configure AWS credentials on controller
  shell: '{{ item }}'
  loop:
    - aws configure set default.aws_access_key_id $(skate get aws_access_key)
    - aws configure set default.aws_secret_access_key $(skate get aws_access_key_secret)
  no_log: true

- name: Check AWS credentials
  command: aws sts get-caller-identity
